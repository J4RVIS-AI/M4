<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>J.A.R.V.I.S. Interface</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap');

        /* --- KEYFRAMES --- */
        @keyframes spin-cw { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes spin-ccw { from { transform: rotate(360deg); } to { transform: rotate(0deg); } }
        @keyframes pulse-core {
            0%, 100% { filter: drop-shadow(0 0 5px currentColor) drop-shadow(0 0 10px currentColor); opacity: 1; }
            50% { filter: drop-shadow(0 0 2px currentColor) drop-shadow(0 0 5px currentColor); opacity: 0.8; }
        }

        body {
            /* Deep Obsidian/Black Gradient */
            background: radial-gradient(circle at center, #0a0a0a 0%, #000000 100%);
            color: #00f3ff;
            font-family: 'Courier Prime', monospace;
            overflow: hidden;
            margin: 0;
            padding: 0;
            height: 100dvh; 
            width: 100vw;
        }

        /* --- REACTOR STYLES --- */
        .reactor-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none; /* Allows clicking through the reactor area */
        }

        .ring {
            position: absolute;
            border-radius: 50%;
            transition: all 0.5s ease;
            box-sizing: border-box;
        }

        /* Outer Mechanical Shell */
        .ring-outer {
            width: 100%;
            height: 100%;
            border: 12px solid transparent; 
            border-top: 12px solid rgba(0, 243, 255, 0.4);
            border-bottom: 12px solid rgba(0, 243, 255, 0.4);
            mask-image: conic-gradient(from 0deg, black 0deg 10deg, transparent 10deg 15deg, black 15deg 40deg, transparent 40deg 42deg, black 42deg 80deg, transparent 80deg 100deg, black 100deg 180deg, transparent 180deg 190deg, black 190deg 220deg, transparent 220deg 225deg, black 225deg 280deg, transparent 280deg 300deg, black 300deg 360deg);
            -webkit-mask-image: conic-gradient(from 0deg, black 0deg 10deg, transparent 10deg 15deg, black 15deg 40deg, transparent 40deg 42deg, black 42deg 80deg, transparent 80deg 100deg, black 100deg 180deg, transparent 180deg 190deg, black 190deg 220deg, transparent 220deg 225deg, black 225deg 280deg, transparent 280deg 300deg, black 300deg 360deg);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.1);
        }

        /* Detailed Grid Ring */
        .ring-grid {
            width: 86%;
            height: 86%;
            border: 1px solid rgba(0, 243, 255, 0.2);
            background: radial-gradient(circle, transparent 65%, rgba(0, 243, 255, 0.05) 70%, transparent 72%), repeating-conic-gradient(from 0deg, transparent 0deg 1.5deg, rgba(0, 243, 255, 0.4) 1.5deg 2deg, transparent 2deg 4deg);
            mask-image: radial-gradient(black 60%, transparent 0), radial-gradient(transparent 85%, black 86%);
            -webkit-mask-image: radial-gradient(transparent 68%, black 69% 98%, transparent 99%);
        }

        /* Inner Tech Ring */
        .ring-inner {
            width: 62%;
            height: 62%;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-left: 2px solid transparent;
            border-right: 2px solid transparent;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.3);
        }

        /* Core Plate */
        .core-plate {
            width: 52%;
            height: 52%;
            border: 2px solid rgba(0, 243, 255, 0.6);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            background: radial-gradient(circle, rgba(0,0,0,1) 0%, rgba(0,0,0,0.8) 100%);
            box-shadow: inset 0 0 20px rgba(0, 243, 255, 0.3);
        }

        /* Logo Text */
        .logo-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px; 
            font-weight: 900;
            letter-spacing: 0.15em;
            color: #ffffff;
            text-shadow: 0 0 5px rgba(0, 243, 255, 0.8);
            margin-left: 0.15em;
        }

        /* Tick Marks */
        .ring-ticks {
            width: 96%;
            height: 96%;
            background: repeating-conic-gradient(from 0deg, transparent 0deg 8deg, rgba(0, 243, 255, 0.2) 8deg 9deg, transparent 9deg 10deg);
            -webkit-mask-image: radial-gradient(transparent 92%, black 93% 97%, transparent 98%);
            opacity: 0.4;
        }

        /* --- UTILITIES --- */
        .hologram-border {
            border: 1px solid rgba(0, 243, 255, 0.2);
            background: rgba(5, 5, 5, 0.6); 
            backdrop-filter: blur(8px);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.05);
        }

        .bg-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            opacity: 0.6; 
        }

        .vignette {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle, transparent 40%, black 120%);
            pointer-events: none;
            z-index: 1;
        }

        .visualizer-bar {
            width: 6px;
            border-radius: 9999px;
            transition: height 0.05s ease, background-color 0.2s ease, opacity 0.2s ease;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0, 243, 255, 0.2); border-radius: 3px; }
        
        @media (min-width: 768px) {
            .logo-text { font-size: 36px; }
            .ring-outer { border-width: 15px; }
        }
    </style>
</head>
<body class="flex flex-col relative text-cyan-400">

    <!-- Background Layers -->
    <canvas id="bg-canvas" class="bg-canvas"></canvas>
    <div class="vignette"></div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm px-4">
        <div class="hologram-border bg-black/90 p-6 rounded-lg w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-cyan-400 text-lg font-bold tracking-widest flex items-center gap-2">
                    <i data-lucide="settings" width="18"></i> CONFIGURATION
                </h2>
                <button id="close-settings" class="text-cyan-600 hover:text-cyan-300"><i data-lucide="x" width="18"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-cyan-500 font-mono block mb-1">GROQ API KEY</label>
                    <input 
                        type="password" 
                        id="api-key-input"
                        placeholder="gsk_..."
                        class="w-full bg-cyan-900/20 border border-cyan-700/50 rounded p-2 text-cyan-100 font-mono text-sm focus:border-cyan-400 outline-none"
                    />
                    <p class="text-[10px] text-cyan-600 mt-1">Required for Whisper & LLaMA integration.</p>
                </div>
                <button id="save-settings" class="w-full bg-cyan-500/20 hover:bg-cyan-500/40 text-cyan-300 font-mono py-2 rounded border border-cyan-500/50 transition-all">
                    INITIALIZE PROTOCOL
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="absolute top-0 left-0 w-full p-4 md:p-6 flex justify-between items-start z-20 pointer-events-none">
        <!-- Control Panel -->
        <div class="pointer-events-auto hidden md:block">
            <div class="hologram-border p-4 rounded-lg w-full max-w-sm flex flex-col gap-4 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-0.5 bg-gradient-to-r from-transparent via-cyan-500 to-transparent opacity-50"></div>
                <div class="flex items-center justify-between border-b border-cyan-900/50 pb-2">
                    <h2 class="text-cyan-400 font-bold tracking-widest flex items-center gap-2 text-sm">
                        <i data-lucide="terminal" width="16"></i> DIAGNOSTICS
                    </h2>
                    <div class="flex gap-1">
                        <div class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></div>
                        <div class="w-1.5 h-1.5 rounded-full bg-yellow-500"></div>
                        <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div class="bg-cyan-900/10 p-2 rounded flex items-center justify-between border border-cyan-900/20">
                        <span class="text-cyan-500">CPU</span>
                        <span id="cpu-val" class="font-mono text-cyan-100">30%</span>
                    </div>
                    <div class="bg-cyan-900/10 p-2 rounded flex items-center justify-between border border-cyan-900/20">
                        <span class="text-cyan-500">MEM</span>
                        <span id="mem-val" class="font-mono text-cyan-100">45%</span>
                    </div>
                    <div class="bg-cyan-900/10 p-2 rounded flex items-center justify-between border border-cyan-900/20">
                        <span class="text-cyan-500">NET</span>
                        <span class="font-mono text-cyan-100 animate-pulse">ON</span>
                    </div>
                    <div class="bg-cyan-900/10 p-2 rounded flex items-center justify-between border border-cyan-900/20">
                        <span class="text-cyan-500">SEC</span>
                        <span class="font-mono text-cyan-100">OK</span>
                    </div>
                </div>
                <div id="log-container" class="bg-black/40 p-2 rounded h-24 overflow-hidden flex flex-col justify-end border border-cyan-900/20 text-[10px]"></div>
            </div>
        </div>

        <!-- Mobile Clock -->
        <div class="md:hidden absolute left-1/2 transform -translate-x-1/2 mt-1">
             <div class="hologram-border px-3 py-1 rounded">
                <span id="mobile-clock" class="text-lg font-mono font-bold tracking-widest text-cyan-400">12:00:00</span>
            </div>
        </div>

        <!-- Status -->
        <div class="flex flex-col items-end gap-2 pointer-events-auto">
            <div class="flex flex-col items-end gap-2 mb-2">
                 <div class="hidden md:flex hologram-border px-4 py-2 rounded-lg items-center gap-3">
                    <i data-lucide="clock" width="18" class="text-cyan-400"></i>
                    <span id="desktop-clock" class="text-xl font-mono font-bold tracking-widest">12:00:00</span>
                </div>
                <div class="flex gap-2">
                    <div class="flex flex-col items-center p-2 hologram-border rounded min-w-[50px] md:min-w-[60px]">
                        <i data-lucide="wifi" width="14"></i>
                        <span class="text-[10px] mt-1">5G</span>
                    </div>
                    <div class="flex flex-col items-center p-2 hologram-border rounded min-w-[50px] md:min-w-[60px] relative overflow-hidden">
                        <div id="mic-level-bar" class="absolute bottom-0 left-0 w-full bg-cyan-500/30 transition-all duration-100" style="height: 0%;"></div>
                        <i id="mic-icon-indicator" data-lucide="bar-chart-3" width="14" class="text-cyan-700 relative z-10"></i>
                        <span id="mic-level-text" class="text-[10px] mt-1 z-10 font-mono relative">0%</span>
                    </div>
                    <div class="flex flex-col items-center p-2 hologram-border rounded min-w-[50px] md:min-w-[60px]">
                        <i data-lucide="battery" width="14"></i>
                        <span class="text-[10px] mt-1">100%</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- LIVE FEED (High Z-Index & Interactive) -->
    <div class="pointer-events-auto absolute z-30 
                bottom-24 left-4 right-4 h-40 
                md:top-28 md:right-6 md:w-96 md:h-64 md:bottom-auto md:left-auto
                hologram-border p-4 rounded-lg flex flex-col gap-2 overflow-hidden shadow-[0_0_20px_rgba(0,0,0,0.8)]">
        <div class="absolute top-0 left-0 w-full h-0.5 bg-gradient-to-r from-transparent via-cyan-500 to-transparent opacity-50"></div>
        <div class="flex items-center justify-between border-b border-cyan-900/50 pb-2">
           <h2 class="text-cyan-400 font-bold tracking-widest flex items-center gap-2 text-sm">
               <i data-lucide="message-square" width="16"></i> LIVE FEED
           </h2>
       </div>
       <!-- Explicitly set pointer-events-auto and overflow-y-auto -->
       <div id="transcript-container" class="flex-1 overflow-y-auto custom-scrollbar flex flex-col gap-3 p-2 pointer-events-auto">
           <div class="text-cyan-700 text-xs italic text-center mt-4">SYSTEM READY...</div>
       </div>
    </div>

    <!-- MAIN INTERFACE (REACTOR) -->
    <main class="flex-1 flex flex-col items-center justify-center relative z-10">
        <!-- Reactor Wrapper -->
        <div class="relative mb-0 md:mb-8 -mt-20 md:mt-0">
            
            <!-- SMALLER REACTOR: w-48 (mobile), w-72 (desktop) -->
            <div id="reactor-container" class="reactor-container w-48 h-48 md:w-72 md:h-72 text-cyan-400 transition-colors duration-500">
                <!-- 1. Outer Mechanical Shell -->
                <div id="ring-outer" class="ring ring-outer"></div>
                <!-- 2. Detailed Grid/Ladder -->
                <div id="ring-grid" class="ring ring-grid"></div>
                <!-- 3. Ticks -->
                <div id="ring-ticks" class="ring ring-ticks"></div>
                <!-- 4. Inner Tech -->
                <div id="ring-inner" class="ring ring-inner"></div>
                <!-- 5. Core Plate + Text -->
                <div class="ring core-plate">
                    <span class="logo-text">J.A.R.V.I.S.</span>
                </div>
            </div>

            <!-- Stats (Desktop) -->
            <div class="absolute -left-32 top-10 text-[10px] text-cyan-700/70 font-mono flex flex-col gap-1 hidden md:flex">
                <span>COORD: 34.05, -118.24</span>
                <span id="target-status">TARGET: LOCKED</span>
                <span id="mode-status">MODE: STANDBY</span>
            </div>
            <div class="absolute -right-32 bottom-10 text-[10px] text-cyan-700/70 font-mono flex flex-col gap-1 text-right hidden md:flex">
                <span>RENDER: GPU-0</span>
                <span>VOLTAGE: STABLE</span>
                <span>CORE TEMP: 45Â°C</span>
            </div>
        </div>

        <!-- Status & Visuals -->
        <div class="flex flex-col items-center gap-4 z-20 w-full px-4 absolute top-[60%] md:static md:top-auto">
            <div class="h-16 flex items-center justify-center w-full">
                <div id="visualizer" class="flex items-center justify-center gap-1 h-16 w-full max-w-md hidden">
                    <!-- Bars -->
                </div>
                <span id="status-text" class="animate-pulse text-sm tracking-widest text-cyan-800 font-bold">
                    [ AWAITING INPUT ]
                </span>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="w-full p-4 md:p-6 flex justify-center z-40 absolute bottom-0 left-0 bg-gradient-to-t from-black via-black/90 to-transparent">
        <div class="hologram-border p-2 rounded-full flex items-center gap-4 w-full max-w-2xl bg-black/60 backdrop-blur-md">
            <button id="mic-btn" class="p-3 rounded-full transition-all duration-300 bg-cyan-500/10 text-cyan-400 hover:bg-cyan-500/30 border border-cyan-500/20">
                <i data-lucide="mic" width="24"></i>
            </button>
            <input type="text" id="command-input" placeholder="Click Mic to Initialize..." disabled class="bg-transparent border-none outline-none text-cyan-100 flex-1 font-mono placeholder-cyan-700/50 text-sm md:text-base"/>
            <button id="open-settings-btn" class="p-3 text-cyan-600 hover:text-cyan-400 transition-colors">
                <i data-lucide="zap" width="20"></i>
            </button>
        </div>
    </footer>

    <!-- LOGIC -->
    <script>
        let API_KEY = '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';
        // Updated System Prompt: Tells AI to use specific COMMANDS for weather instead of just searching
        const JARVIS_SYSTEM_PROMPT = `
    You are J.A.R.V.I.S, a smart artificial assistant.
    Current System Date: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}
    
    INSTRUCTIONS:
    1. Answer general knowledge questions directly.
    2. DO NOT tell the user you are "searching" or "opening a tab" unless absolutely necessary.
    3. FOR WEATHER: If the user asks for weather, output EXACTLY this format: "CMD:WEATHER [CityName]"
       Example: User: "Weather in Bihar?" -> You: "CMD:WEATHER Bihar"
    4. FOR TIME: Use the Current System Date provided above.
    5. Be concise, robotic but polite (Iron Man style). Address user as "Sir".
    
    KNOWLEDGE BASE:
    - School: Pride International School, Narkatiaganj.
    - Developers: Faraz, Vidhan, Saurabh.
`;

        // Background Animation Script
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];
        let audioIntensity = 0; 

        function resizeCanvas() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        class Particle {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.vx = (Math.random() - 0.5) * 0.5;
                this.vy = (Math.random() - 0.5) * 0.5;
                this.size = Math.random() * 2 + 1; 
                this.opacity = Math.random() * 0.3 + 0.1; 
            }
            update() {
                this.x += this.vx * (1 + audioIntensity * 3); 
                this.y += this.vy * (1 + audioIntensity * 3);
                if (this.x < 0 || this.x > width) this.vx *= -1;
                if (this.y < 0 || this.y > height) this.vy *= -1;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(0, 243, 255, ${this.opacity + (audioIntensity * 0.5)})`; 
                ctx.fill();
            }
        }

        function initParticles() {
            particles = [];
            const particleCount = Math.min(window.innerWidth / 10, 100); 
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle());
            }
        }

        function animateParticles() {
            ctx.clearRect(0, 0, width, height);
            particles.forEach((p, index) => {
                p.update();
                p.draw();
                for (let j = index + 1; j < particles.length; j++) {
                    const p2 = particles[j];
                    const dx = p.x - p2.x;
                    const dy = p.y - p2.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < 120) {
                        ctx.beginPath();
                        const dynamicOpacity = (0.15 - distance/600) + (audioIntensity * 0.3);
                        if(dynamicOpacity > 0) {
                            ctx.strokeStyle = `rgba(0, 243, 255, ${dynamicOpacity})`;
                            ctx.lineWidth = 0.5; 
                            ctx.moveTo(p.x, p.y);
                            ctx.lineTo(p2.x, p2.y);
                            ctx.stroke();
                        }
                    }
                }
            });
            requestAnimationFrame(animateParticles);
        }

        initParticles();
        animateParticles();

        // --- CORE LOGIC ---
        let isSessionActive = false;
        let isListening = false;
        let isProcessing = false;
        let isSpeaking = false;
        let messages = [];
        let selectedVoice = null; 
        
        let lastSpeakingTime = Date.now();
        let sessionStartTime = 0;
        let hasSpoken = false;
        let shouldProcess = false;

        let mediaRecorder = null;
        let audioChunks = [];
        let audioContext = null;
        let analyser = null;
        
        const reactorContainer = document.getElementById('reactor-container');
        const ringOuter = document.getElementById('ring-outer');
        const ringGrid = document.getElementById('ring-grid');
        const ringTicks = document.getElementById('ring-ticks');
        const ringInner = document.getElementById('ring-inner');
        const micBtn = document.getElementById('mic-btn');
        const inputField = document.getElementById('command-input');
        const visualizerDiv = document.getElementById('visualizer');
        const statusText = document.getElementById('status-text');
        const logContainer = document.getElementById('log-container');
        const transcriptContainer = document.getElementById('transcript-container');
        const targetStatus = document.getElementById('target-status');
        const modeStatus = document.getElementById('mode-status');
        const settingsModal = document.getElementById('settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');

        window.onload = () => {
            lucide.createIcons();
            startClock();
            startRandomStats();
            apiKeyInput.value = API_KEY;
            
            for(let i=0; i<20; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar bg-cyan-400';
                bar.style.height = '4px';
                bar.id = `bar-${i}`;
                visualizerDiv.appendChild(bar);
            }
            
            addLog("SYSTEM INITIALIZED");
            window.speechSynthesis.getVoices(); 
            resetReactorAnimation();
        };

        window.speechSynthesis.onvoiceschanged = () => {
            if (!selectedVoice) {
                const voices = window.speechSynthesis.getVoices();
                selectedVoice = voices.find(v => v.name.includes("Google UK English Male")) || 
                                voices.find(v => v.name.includes("Microsoft David")) || 
                                voices.find(v => v.name.toLowerCase().includes("male")) || 
                                voices.find(v => v.name.includes("Daniel")) ||
                                voices.find(v => v.lang === "en-US" && v.name.includes("Google")) ||
                                voices[0];
                if (selectedVoice) addLog(`VOICE LOCKED: ${selectedVoice.name.substring(0, 15)}...`);
            }
        };

        function resetReactorAnimation() {
            ringOuter.style.animation = "spin-cw 20s linear infinite";
            ringGrid.style.animation = "spin-ccw 30s linear infinite";
            ringTicks.style.animation = "spin-cw 25s linear infinite";
            ringInner.style.animation = "spin-ccw 10s linear infinite";
            reactorContainer.className = "reactor-container w-48 h-48 md:w-72 md:h-72 text-cyan-400 transition-colors duration-500";
        }

        function updateUI() {
            if (isSessionActive) {
                micBtn.className = "p-3 rounded-full transition-all duration-300 bg-red-500/20 text-red-400 shadow-[0_0_15px_#ef4444]";
                inputField.placeholder = "Continuous Mode...";
                statusText.innerText = "[ LISTENING ]";
                statusText.className = "animate-pulse text-sm tracking-widest text-cyan-400 font-bold";
                if(modeStatus) modeStatus.innerText = "MODE: CONTINUOUS";
            } else {
                micBtn.className = "p-3 rounded-full transition-all duration-300 bg-cyan-500/10 text-cyan-400 hover:bg-cyan-500/30 border border-cyan-500/20";
                inputField.placeholder = "Click Mic to Initialize...";
                statusText.innerText = "[ AWAITING INPUT ]";
                statusText.className = "animate-pulse text-sm tracking-widest text-cyan-800 font-bold";
                if(modeStatus) modeStatus.innerText = "MODE: STANDBY";
            }

            if (isListening) {
                visualizerDiv.classList.remove('hidden');
                statusText.classList.add('hidden');
                if(targetStatus) targetStatus.innerText = "TARGET: AUDIO_INPUT";
                
                reactorContainer.className = "reactor-container w-48 h-48 md:w-72 md:h-72 text-cyan-400 transition-colors duration-500";
                ringOuter.style.animation = "spin-cw 5s linear infinite";
                ringGrid.style.animation = "spin-ccw 8s linear infinite";
                ringInner.style.animation = "spin-ccw 2s linear infinite, pulse-core 1s infinite";

            } else if (isProcessing) {
                visualizerDiv.classList.add('hidden');
                statusText.classList.remove('hidden');
                statusText.innerText = "[ PROCESSING ]";
                statusText.className = "animate-pulse text-sm tracking-widest text-amber-500 font-bold";
                if(targetStatus) targetStatus.innerText = "TARGET: NEURAL_NET";

                reactorContainer.className = "reactor-container w-48 h-48 md:w-72 md:h-72 text-amber-500 transition-colors duration-500";
                ringOuter.style.animation = "spin-cw 2s linear infinite";
                ringInner.style.animation = "spin-ccw 1s linear infinite, pulse-core 0.5s infinite";

            } else if (isSpeaking) {
                visualizerDiv.classList.remove('hidden');
                statusText.classList.add('hidden');
                if(targetStatus) targetStatus.innerText = "TARGET: VOCAL_SYNTHESIS";

                reactorContainer.className = "reactor-container w-48 h-48 md:w-72 md:h-72 text-emerald-400 transition-colors duration-500";
                ringOuter.style.animation = "spin-cw 10s linear infinite";
                ringInner.style.animation = "spin-ccw 5s linear infinite, pulse-core 0.2s infinite";

            } else {
                visualizerDiv.classList.add('hidden');
                statusText.classList.remove('hidden');
                if(targetStatus) targetStatus.innerText = "TARGET: LOCKED";
                
                if (isSessionActive) {
                    reactorContainer.className = "reactor-container w-48 h-48 md:w-72 md:h-72 text-red-400 transition-colors duration-500";
                    resetReactorAnimation();
                } else {
                    reactorContainer.className = "reactor-container w-48 h-48 md:w-72 md:h-72 text-cyan-800 transition-colors duration-500";
                    resetReactorAnimation();
                }
            }
        }

        function addLog(msg) {
            const time = new Date().toLocaleTimeString();
            const logLine = document.createElement('div');
            logLine.className = "text-[10px] font-mono text-cyan-500/80 whitespace-nowrap overflow-hidden text-ellipsis px-1";
            logLine.innerText = `[${time}] >> ${msg}`;
            logContainer.prepend(logLine);
            if(logContainer.children.length > 8) logContainer.lastChild.remove();
        }

        function addTranscript(role, text) {
            if (transcriptContainer.firstElementChild && transcriptContainer.firstElementChild.innerText.includes("SYSTEM READY")) {
                transcriptContainer.innerHTML = '';
            }
            const wrapper = document.createElement('div');
            wrapper.className = `flex flex-col ${role === 'user' ? 'items-end' : 'items-start'}`;
            
            const label = document.createElement('span');
            label.className = "text-[10px] text-cyan-600 mb-0.5 uppercase tracking-wider";
            label.innerText = role === 'user' ? 'COMMAND' : 'RESPONSE';
            
            const content = document.createElement('div');
            content.className = `text-xs font-mono p-2 rounded border ${
                role === 'user' 
                ? 'border-cyan-500/30 bg-cyan-900/20 text-cyan-100' 
                : 'border-emerald-500/30 bg-emerald-900/10 text-emerald-100'
            }`;
            content.innerText = text;

            wrapper.appendChild(label);
            wrapper.appendChild(content);
            transcriptContainer.appendChild(wrapper);
            transcriptContainer.scrollTop = transcriptContainer.scrollHeight;
            messages.push({ role: role, content: text });
        }

        function setupAudioAnalyzer(stream) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!audioContext) audioContext = new AudioContext();
            else if (audioContext.state === 'suspended') audioContext.resume();

            const source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 64;
            analyser.smoothingTimeConstant = 0.5;
            source.connect(analyser);

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function updateVisualizer() {
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for(let i=0; i<bufferLength; i++) sum += dataArray[i];
                const averageVolume = sum / bufferLength;
                
                audioIntensity = averageVolume / 255; 

                const percentage = Math.min(100, Math.floor((averageVolume / 255) * 100 * 3));
                document.getElementById('mic-level-bar').style.height = `${percentage}%`;
                document.getElementById('mic-level-text').innerText = `${percentage}%`;
                
                const micIcon = document.getElementById('mic-icon-indicator');
                if(isListening) micIcon.classList.add('text-cyan-400', 'animate-pulse');
                else micIcon.classList.remove('text-cyan-400', 'animate-pulse');

                if (isListening && mediaRecorder && mediaRecorder.state === 'recording') {
                    if (averageVolume > 10) { 
                        lastSpeakingTime = Date.now();
                        hasSpoken = true;
                    }
                    if (hasSpoken && (Date.now() - lastSpeakingTime > 2000)) {
                        shouldProcess = true; 
                        stopListening();
                    }
                    if (Date.now() - sessionStartTime > 10000) {
                        shouldProcess = true;
                        stopListening();
                    }
                }

                const step = Math.floor(bufferLength / 20);
                for(let i=0; i<20; i++) {
                    const value = dataArray[i * step];
                    const bar = document.getElementById(`bar-${i}`);
                    if(bar) {
                        const h = Math.max(4, value / 2);
                        bar.style.height = `${h}px`;
                        bar.style.backgroundColor = isSpeaking ? '#10b981' : '#22d3ee';
                        bar.style.opacity = 0.6 + (value / 255) * 0.4;
                    }
                }
                if (isSessionActive || isListening || isSpeaking) {
                    animationFrameId = requestAnimationFrame(updateVisualizer);
                }
            }
            updateVisualizer();
        }

        async function startListening() {
            if (!API_KEY) {
                addLog("ERROR: API KEY MISSING");
                toggleSettings();
                return;
            }
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!audioContext) audioContext = new AudioContext();
                if (audioContext.state === 'suspended') await audioContext.resume();

                hasSpoken = false;
                lastSpeakingTime = Date.now();
                sessionStartTime = Date.now(); 
                shouldProcess = false;

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                streamRef = stream;

                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) audioChunks.push(e.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    if (streamRef) streamRef.getTracks().forEach(track => track.stop());

                    if (isSessionActive && (shouldProcess || audioBlob.size > 3000)) {
                        processAudio(audioBlob);
                    } else {
                        if (isSessionActive && !isProcessing && !isSpeaking) {
                            addLog("NO INPUT / RETRYING");
                            startListening();
                        } else {
                            if (!isSessionActive) addLog("SESSION ENDED");
                        }
                    }
                };

                setupAudioAnalyzer(stream);
                mediaRecorder.start(100);
                isListening = true;
                addLog("LISTENING ACTIVE");
                updateUI();

            } catch (err) {
                console.error(err);
                addLog("AUDIO ERROR: " + err.message);
                isSessionActive = false;
                updateUI();
            }
        }

        function stopListening() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                isListening = false;
                addLog("ANALYZING AUDIO...");
                updateUI();
            }
        }

        async function processAudio(audioBlob) {
            if (audioBlob.size < 500) {
                if (isSessionActive) startListening();
                return;
            }
            isProcessing = true;
            updateUI();
            addLog(`UPLOADING...`);

            const formData = new FormData();
            formData.append('file', audioBlob, 'input.wav');
            formData.append('model', 'whisper-large-v3-turbo');

            try {
                const resp = await fetch('https://api.groq.com/openai/v1/audio/transcriptions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${API_KEY}` },
                    body: formData
                });
                const data = await resp.json();
                if (data.error) throw new Error(data.error.message);

                const text = data.text;
                if (!text || text.trim().length === 0) {
                    isProcessing = false;
                    updateUI();
                    if (isSessionActive) startListening();
                    return;
                }
                addLog(`RECOGNIZED: "${text.substring(0, 15)}..."`);
                addTranscript('user', text);
                await runInference(text);

            } catch (err) {
                console.error(err);
                addLog(`ERROR: ${err.message}`);
                isProcessing = false;
                updateUI();
                if (isSessionActive) setTimeout(startListening, 1000);
            }
        }

        async function runInference(text) {
            addLog("PROCESSING REQUEST...");
            
            const apiMessages = [
                { role: "system", content: JARVIS_SYSTEM_PROMPT },
                ...messages.slice(-4),
                { role: "user", content: text }
            ];
            
            try {
                const resp = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: apiMessages,
                        model: "llama-3.1-8b-instant",
                        temperature: 0.7,
                        max_tokens: 150
                    })
                });
                
                const data = await resp.json();
                if (data.error) throw new Error(data.error.message);
                const aiText = data.choices[0].message.content;
                
                // INTERCEPT COMMANDS
                if (aiText.includes("CMD:WEATHER")) {
                    const city = aiText.split("CMD:WEATHER")[1].trim();
                    await fetchWeather(city);
                } else {
                    addTranscript('assistant', aiText);
                    addLog("REPLY GENERATED");
                    speak(aiText);
                }
            } catch (err) {
                addLog(`LLM ERROR: ${err.message}`);
                isProcessing = false;
                updateUI();
                if (isSessionActive) setTimeout(startListening, 1000);
            }
        }

        // --- REAL WEATHER BACKEND (Client-side Fetch) ---
        async function fetchWeather(city) {
            addLog(`FETCHING WEATHER: ${city}`);
            addTranscript('assistant', `Accessing meteorological satellites for ${city}...`);
            
            try {
                // 1. Geocoding
                const geoResp = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=en&format=json`);
                const geoData = await geoResp.json();
                
                if (!geoData.results) {
                    speak(`I could not locate ${city} in my database, Sir.`);
                    return;
                }
                
                const { latitude, longitude, name, admin1 } = geoData.results[0];
                
                // 2. Weather Data
                const weatherResp = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`);
                const weatherData = await weatherResp.json();
                
                const temp = weatherData.current_weather.temperature;
                const wind = weatherData.current_weather.windspeed;
                
                const responseText = `The current temperature in ${name}, ${admin1 || ''} is ${temp} degrees Celsius with wind speeds of ${wind} kilometers per hour.`;
                
                addTranscript('assistant', responseText);
                speak(responseText);
                
            } catch (err) {
                console.error(err);
                speak("I encountered an error accessing the weather grid, Sir.");
            }
        }

        function speak(text) {
            isProcessing = false;
            isSpeaking = true;
            updateUI();
            addLog("SPEAKING...");

            const speechText = text.replace(/SEARCHING:.*?\./i, "Initiating search protocol.").replace(/CMD:WEATHER/g, "");
            const utterance = new SpeechSynthesisUtterance(speechText);
            utterance.rate = 0.9;
            utterance.pitch = 0.7;

            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }

            const speakInterval = setInterval(() => {
                const bars = document.querySelectorAll('.visualizer-bar');
                bars.forEach(bar => {
                    const h = Math.random() * 20 + 4;
                    bar.style.height = `${h}px`;
                });
            }, 100);

            utterance.onend = () => {
                isSpeaking = false;
                clearInterval(speakInterval);
                addLog("WAITING FOR INPUT");
                updateUI();
                document.querySelectorAll('.visualizer-bar').forEach(b => b.style.height = '4px');
                if (isSessionActive) startListening();
            };
            window.speechSynthesis.speak(utterance);
        }

        micBtn.onclick = () => {
            if (isSessionActive) {
                isSessionActive = false;
                shouldProcess = false; 
                if (isListening) stopListening();
                if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
                window.speechSynthesis.cancel();
                isSpeaking = false;
                isProcessing = false;
                isListening = false;
                addLog("SESSION TERMINATED");
                updateUI();
            } else {
                isSessionActive = true;
                startListening();
            }
        };

        document.getElementById('open-settings-btn').onclick = toggleSettings;
        document.getElementById('close-settings').onclick = toggleSettings;
        document.getElementById('save-settings').onclick = () => {
            API_KEY = apiKeyInput.value;
            localStorage.setItem('jarvis_groq_key', API_KEY);
            toggleSettings();
            addLog("KEY UPDATED");
        };

        function toggleSettings() {
            settingsModal.classList.toggle('hidden');
        }

        function startClock() {
            setInterval(() => {
                const now = new Date();
                const timeStr = now.toLocaleTimeString([], { hour12: false });
                document.getElementById('desktop-clock').innerText = timeStr;
                document.getElementById('mobile-clock').innerText = timeStr;
            }, 1000);
        }

        function startRandomStats() {
            // Lowered range: CPU (5% - 20%), MEM (15% - 35%)
            document.getElementById('cpu-val').innerText = (Math.floor(Math.random() * 15) + 5) + '%';
            document.getElementById('mem-val').innerText = (Math.floor(Math.random() * 20) + 15) + '%';
            setInterval(() => {
                document.getElementById('cpu-val').innerText = (Math.floor(Math.random() * 15) + 5) + '%';
                document.getElementById('mem-val').innerText = (Math.floor(Math.random() * 20) + 15) + '%';
            }, 1500);
        }
    </script>
</body>
</html>
